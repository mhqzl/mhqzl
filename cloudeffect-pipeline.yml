version: v1
steps:
  - name: 检出代码
    type: git-checkout
    params:
      repository: github.com/your-repo/pytest-demo
      branch: main

  - name: 安装依赖
    type: script
    script: |
      python3 -m venv venv
      source venv/bin/activate
      pip install -r requirements.txt

  - name: 执行测试
    type: custom
    image: python:3.9-slim
    commands: |
      source venv/bin/activate
      pytest --alluredir=./allure-results

  - name: 生成报告
    type: custom
    image: python:3.9-slim
    commands: |
      wget -q https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.17.3/allure-commandline-2.17.3.tgz
      tar -zxvf allure-commandline-2.17.3.tgz -C /opt/
      ln -s /opt/allure-2.17.3/bin/allure /usr/bin/allure
      allure generate allure-results -o allure-report --clean

  - name: 保存报告
    type: artifact-save
    params:
      source: allure-report/
      target: report/  