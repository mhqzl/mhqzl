version: v1
steps:
  - name: 检出代码
    type: git-checkout
    params:
      repository: github.com/your-repo/pytest-demo
      branch: main

  - name: 安装依赖
    type: custom
    image: python:3.9-slim
    commands: |
      pip install -r requirements.txt

  - name: 执行测试
    type: custom
    image: python:3.9-slim
    commands: |
      pytest --alluredir=./allure-results --html=./report.html

  - name: 生成Allure报告
    type: custom
    image: python:3.9-slim
    commands: |
      wget -q https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.17.3/allure-commandline-2.17.3.tgz
      tar -zxvf allure-commandline-2.17.3.tgz -C /opt/
      ln -s /opt/allure-2.17.3/bin/allure /usr/bin/allure
      allure generate allure-results -o allure-report --clean

  - name: 保存HTML报告
    type: artifact-save
    params:
      source: report.html
      target: report/

  - name: 保存Allure报告
    type: artifact-save
    params:
      source: allure-report/
      target: allure-report/

  - name: 发布HTML报告
    type: web-publish
    params:
      name: 测试HTML报告
      path: report/report.html

  - name: 发布Allure报告
    type: web-publish
    params:
      name: 测试Allure报告
      path: allure-report/